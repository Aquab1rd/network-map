<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alongside Ministries — Network Map</title>

  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    :root { --bg:#0f1115; --panel:#151922; --ink:#e8ebf2; --muted:#9aa3b2; --accent:#3aa0ff; }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--ink); font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;}
    .wrap { max-width:1200px; margin:0 auto; padding:20px; }
    h1 { font-size:20px; margin:4px 0 12px; font-weight:700; }
    .hint { color:var(--muted); font-size:12px; margin:4px 0 14px; }
    .grid { display:grid; grid-template-columns: 1fr 380px; gap:16px; }
    .card { background:var(--panel); border:1px solid #202634; border-radius:12px; padding:12px; }
    #map { height:520px; border-radius:10px; overflow:hidden; }
    #net { height:560px; border-radius:10px; overflow:hidden; }
    .controls { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;}
    .controls label { display:flex; flex-direction:column; gap:6px; font-size:12px; color:var(--muted); }
    select, input[type="text"], button { background:#0c0f16; color:var(--ink); border:1px solid #273043; border-radius:8px; padding:8px 10px; min-width:160px;}
    button { cursor:pointer; }
    .legend { display:flex; flex-wrap:wrap; gap:10px 16px; margin:8px 0 4px; }
    .chip { display:inline-flex; align-items:center; gap:6px; font-size:12px; color:var(--muted); }
    .dot { width:10px; height:10px; border-radius:50%; display:inline-block; outline:1px solid #111; }
    .details { white-space:pre-wrap; }
    a { color:var(--accent); text-decoration:none; }
    a:hover { text-decoration:underline; }
    @media (max-width: 1100px) {.grid { grid-template-columns: 1fr; }}
    .error { color:#ff7b7b; font-weight:600; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Alongside Ministries — Interactive Network Map</h1>
    <div id="status" class="hint">Loading data…</div>

    <div class="controls card">
      <label>Type
        <select id="typeFilter"><option>All</option></select>
      </label>
      <label>Tag
        <select id="tagFilter"><option>Any</option></select>
      </label>
      <label>Search
        <input id="searchBox" type="text" placeholder="Type a name…"/>
      </label>
      <label style="align-items:center;flex-direction:row;gap:8px;margin-top:22px">
        <input id="onlyAlongsider" type="checkbox" /> Only connections of selected alongsider
      </label>
      <button id="clearSel" style="align-self:end">Clear selection</button>
    </div>

    <div class="legend card" id="legend"></div>

    <div class="grid">
      <div class="card">
        <div id="map"></div>
      </div>
      <div class="card details" id="details">(Click a pin or node to see details)</div>
      <div class="card" style="grid-column: 1 / -1;">
        <div id="net"></div>
      </div>
    </div>
  </div>

  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://unpkg.com/graphology@0.25.4/dist/graphology.umd.min.js"></script>
  <script src="https://unpkg.com/sigma@2.5.0/build/sigma.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
  (async function(){
    const NODES_CSV_URL = "https://docs.google.com/spreadsheets/d/1MSwF46BkDjRhOdHd4Pw0ArCVgvdcgDACWvyswFq8XI4/gviz/tq?tqx=out:csv&sheet=Nodes";
    const EDGES_CSV_URL = "https://docs.google.com/spreadsheets/d/1eQrmiVA4wxf6J79SZkyhZb-vEAyX3yxfapen113MSrA/gviz/tq?tqx=out:csv&sheet=Edges";
    const MAPBOX_TOKEN  = "pk.eyJ1IjoiYXF1YWIxcmQiLCJhIjoiY21ndjl5Y2RzMGN2azJsc2J4d3d2N2tyeSJ9.JApvZZEs_kiwNl4Y9-aRaQ";

    const status = document.getElementById('status');
    function setStatus(msg,isErr=false){status.innerHTML=isErr?`<span class="error">${msg}</span>`:msg;}

    async function loadCSV(url){
      const r = await fetch(url,{cache:"no-store"});
      if(!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
      const t = await r.text();
      const p = Papa.parse(t,{header:true,skipEmptyLines:true,dynamicTyping:true});
      return p.data;
    }

    let rawNodes, rawEdges;
    try {
      [rawNodes, rawEdges] = await Promise.all([loadCSV(NODES_CSV_URL), loadCSV(EDGES_CSV_URL)]);
    } catch (e) {
      setStatus(`Couldn't load Sheets<br>${e.message}`, true);
      return;
    }

    const nodes = rawNodes.map(d=>({
      id: String(d.id).trim(),
      name: d.name,
      type: d.type,
      city: d.city,
      country: d.country,
      lat: Number(d.lat),
      lon: Number(d.lon),
      tags: String(d.tags||"").split(/[;,]/).map(x=>x.trim()).filter(Boolean),
      alongsider: String(d.alongsider||"").split(/[;,]/).map(x=>x.trim()).filter(Boolean),
      url: d.url,
      public: String(d.public).toLowerCase() === "true"
    })).filter(n=>n.id && Number.isFinite(n.lat)&&Number.isFinite(n.lon)&&n.public);

    const nodeById = new Map(nodes.map(n=>[n.id,n]));

    const edges = rawEdges.map(e=>({
      source: String(e.source_id).trim(),
      target: String(e.target_id).trim(),
      relationship: e.relationship,
      since: e.since
    })).filter(e=>nodeById.has(e.source)&&nodeById.has(e.target)&&e.source!==e.target);

    setStatus(`Loaded <b>${nodes.length}</b> nodes and <b>${edges.length}</b> edges.`);

    // Map
    mapboxgl.accessToken = MAPBOX_TOKEN;
    const map = new mapboxgl.Map({
      container:"map",
      style:"mapbox://styles/mapbox/light-v11",
      center:[0,20],
      zoom:1.5
    });
    map.addControl(new mapboxgl.NavigationControl());

    function refreshMap(ids){
      if(!map.isStyleLoaded()){map.once("load",()=>refreshMap(ids));return;}
      const data={
        type:"FeatureCollection",
        features:Array.from(ids).map(id=>{
          const n=nodeById.get(id);
          return {type:"Feature",geometry:{type:"Point",coordinates:[n.lon,n.lat]},
            properties:{id:n.id,name:n.name,type:n.type,color:"#ff3b3b"}};
        })
      };
      if(map.getSource("nodes")) map.getSource("nodes").setData(data);
      else{
        map.addSource("nodes",{type:"geojson",data});
        map.addLayer({
          id:"nodes",
          type:"circle",
          source:"nodes",
          paint:{
            "circle-radius":10,
            "circle-stroke-width":2,
            "circle-color":["coalesce",["get","color"],"#ff3b3b"],
            "circle-stroke-color":"#000",
            "circle-opacity":0.95
          }
        });
        // add debug layer for first feature
        const first=data.features[0];
        if(first){
          map.addLayer({
            id:"nodes-debug",
            type:"circle",
            source:"nodes",
            filter:["==",["get","id"],first.properties.id],
            paint:{
              "circle-radius":16,
              "circle-color":"#00e676",
              "circle-stroke-color":"#003300",
              "circle-stroke-width":3,
              "circle-opacity":0.9
            }
          });
        }
      }
      map.fitBounds([[-180,-60],[180,85]],{padding:40});
      setStatus(`Loaded <b>${nodes.length}</b> nodes and <b>${edges.length}</b> edges. Showing <b>${data.features.length}</b> pins.`);
    }

    // Graph
    const G = new graphology.Graph();
    for(const n of nodes) G.addNode(n.id,{label:n.name,x:Math.random(),y:Math.random(),size:6,color:"#ff3b3b"});
    for(const e of edges) G.addEdge(e.source,e.target);
    const renderer=new sigma.Sigma(G,document.getElementById('net'));

    const ids = new Set(nodes.map(n=>n.id));
    map.once("load",()=>refreshMap(ids));

  })();
  </script>
</body>
</html>
