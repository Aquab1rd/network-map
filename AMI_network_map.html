<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Alongside Network Map</title>

  <!-- Mapbox GL -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <!-- Papa Parse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Fonts (optional) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Deep dark w/ blue-green accents */
      --bg:#0c1016;
      --bg-grad1:#0c1016;
      --bg-grad2:#0a1220;
      --ink:#e9f1ff;
      --muted:#9fb0c7;
      --border:#1b2a3a;
      --accent:#35b3a8;   /* teal */
      --accent2:#4fb3ff;  /* cyan-blue */
      --panel:#0f1622;

      /* Type colors */
      --t-alongsider:#4dd4c6;  /* teal */
      --t-church:#8f7bff;      /* violet */
      --t-partner:#ffb86b;     /* amber */
      --t-supporter:#6fe38b;   /* green */

      /* Relationship colors */
      --r-leads:#4fb3ff;
      --r-supports:#6fe38b;
      --r-partners:#ffb86b;
      --r-linked:#a9bbd0;

      --shadow: 0 10px 30px rgba(53,179,168,0.20), 0 2px 10px rgba(79,179,255,0.12);
      --glow: 0 0 0 1px rgba(79,179,255,0.25), 0 0 18px rgba(53,179,168,0.24), inset 0 0 0 1px rgba(26,46,64,0.8);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink); background:
        radial-gradient(1200px 600px at 20% 10%, rgba(53,179,168,0.08), transparent 60%),
        radial-gradient(900px 900px at 90% -10%, rgba(79,179,255,0.10), transparent 60%),
        linear-gradient(180deg, var(--bg-grad1), var(--bg-grad2));
      font:14px/1.45 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    .site{
      min-height:100vh;
      display:grid;
      grid-template-rows:auto 1fr auto;
    }

    header{
      position:sticky; top:0; z-index:1000;
      background:linear-gradient(180deg, rgba(12,16,22,0.96), rgba(12,16,22,0.75) 75%, rgba(12,16,22,0));
      border-bottom:1px solid var(--border);
      backdrop-filter: blur(6px) saturate(130%);
      animation: fadeIn 450ms ease;
    }
    .nav{
      max-width:1300px; margin:0 auto; padding:12px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:600; letter-spacing:.2px;
      text-shadow: 0 1px 0 rgba(0,0,0,.4);
    }
    .brand a{color:var(--ink); text-decoration:none}
    .chip{
      font-size:12px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; color:var(--muted);
      background:rgba(15,22,34,0.75);
    }
    .nav-actions{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .btn, select, input, button{
      background:#0b1522; color:var(--ink); border:1px solid var(--border);
      border-radius:12px; padding:8px 12px; font:inherit;
      transition: border-color .2s ease, transform .08s ease, box-shadow .2s ease;
    }
    .btn:hover, select:hover, input:hover{ border-color:#2b425b; }
    .btn.primary{
      background:linear-gradient(180deg, var(--accent2), var(--accent));
      color:#06121a; border:0; box-shadow: var(--shadow);
    }
    .btn.primary:hover{ filter:brightness(1.05); transform: translateY(-1px); }

    /* Layout: map main + right sidebar */
    .main{
      max-width:1300px; margin:14px auto; padding:0 16px;
      display:grid; gap:14px;
      grid-template-columns: 1fr 360px;  /* sidebar on the RIGHT */
    }
    @media (max-width: 980px){
      .main{ grid-template-columns: 1fr; }
    }

    /* Map card */
    .map-card{
      background:rgba(13,18,28,0.6); border:1px solid var(--border);
      border-radius:16px; overflow:hidden; box-shadow: var(--shadow);
      animation: floatIn 500ms ease;
    }
    /* SAFER HEIGHT */
    .map-wrap{ position:relative; height: 80vh; min-height:520px; }
    #map{ position:absolute; inset:0; }

    .toolbar{
      position:absolute; top:12px; left:12px; z-index:10;
      display:flex; gap:8px; flex-wrap:wrap;
      background:rgba(8,14,22,0.7); border:1px solid var(--border); padding:8px; border-radius:12px;
      backdrop-filter: blur(6px);
      box-shadow: var(--glow);
    }

    .toast{
      position:absolute; bottom:12px; right:12px; z-index:10;
      background:rgba(8,14,22,0.85); border:1px solid var(--border); color:var(--muted);
      padding:8px 12px; border-radius:10px; font-size:12px;
      box-shadow: var(--glow); display:none;
    }

    /* Sidebar */
    .side{ display:flex; flex-direction:column; gap:14px; }
    .card{
      background:rgba(13,18,28,0.7); border:1px solid var(--border); border-radius:16px; padding:14px;
      box-shadow: var(--shadow); animation: fadeIn 400ms ease;
    }
    .card h3{ margin:0 0 10px; font-size:16px; letter-spacing:.2px; }
    .muted{ color:var(--muted); }
    .group{ display:grid; gap:8px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    .legend{ display:flex; gap:8px; flex-wrap:wrap }
    .pill{
      display:flex; align-items:center; gap:8px; padding:6px 10px; font-size:12px;
      border:1px solid var(--border); border-radius:999px; background:#0b1522;
    }
    .dot{ width:10px; height:10px; border-radius:50%; }
    .rect{ width:12px; height:8px; border-radius:2px; }
    .diamond{ width:10px; height:10px; transform:rotate(45deg); border-radius:2px; }

    .cluster{
      max-height:260px; overflow:auto; border:1px solid var(--border);
      border-radius:12px; padding:8px; background:#0b1522;
      box-shadow: var(--glow);
    }
    .cluster-item{
      padding:10px; border-radius:10px; display:flex; justify-content:space-between; gap:8px; cursor:pointer;
      border:1px solid transparent; transition: background .15s ease, border-color .15s ease, transform .08s ease;
    }
    .cluster-item:hover{ background:#0e1b2b; border-color:#2b425b; transform: translateY(-1px); }
    .tag{ font-size:11px; color:var(--muted); }
    .divider{ height:1px; background:var(--border); margin:8px 0; }

    footer{
      color:var(--muted); font-size:12px; text-align:center; padding:16px; border-top:1px solid var(--border);
    }

    /* Color helpers */
    .c-alongsider{ background:var(--t-alongsider) }
    .c-church{ background:var(--t-church) }
    .c-partner{ background:var(--t-partner) }
    .c-supporter{ background:var(--t-supporter) }
    .r-leads{ background:var(--r-leads) }
    .r-supports{ background:var(--r-supports) }
    .r-partners{ background:var(--r-partners) }
    .r-linked{ background:var(--r-linked) }

    /* Animations */
    @keyframes fadeIn { from { opacity:0; transform: translateY(4px) } to { opacity:1; transform:none } }
    @keyframes floatIn { from { opacity:0; transform: translateY(8px) } to { opacity:1; transform:none } }

    /* Mapbox popup restyle */
    .mapboxgl-popup{
      font: 13px/1.45 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    .mapboxgl-popup-content{
      background:#0b1522; color:var(--ink); border:1px solid var(--border); border-radius:12px;
      box-shadow: var(--glow);
    }
    .mapboxgl-ctrl-attrib, .mapboxgl-ctrl-logo{filter:brightness(.8)}
  </style>
</head>
<body>
  <div class="site">
    <header>
      <div class="nav">
        <div class="brand">
          <a href="index.html">Alongside Network</a>
          <span class="chip">Live</span>
        </div>
        <div class="nav-actions">
          <a class="btn" href="register.html">Submit / Update</a>
          <a class="btn" href="donate.html">Donate</a>
          <a class="btn primary" href="#help">Help</a>
        </div>
      </div>
    </header>

    <main class="main">
      <!-- Map -->
      <section class="map-card">
        <div class="map-wrap">
          <div class="toolbar">
            <select id="quickType">
              <option value="All">All types</option>
              <option value="Alongsider">Alongsider</option>
              <option value="Church">Church</option>
              <option value="Partner Org">Partner Org</option>
              <option value="Supporter">Supporter</option>
            </select>
            <input id="quickSearch" placeholder="Search name…" />
            <button class="btn" id="resetView">Reset</button>
          </div>
          <div id="map"></div>
          <div class="toast" id="toast"></div>
        </div>
      </section>

      <!-- Sidebar (on the right) -->
      <aside class="side">
        <div class="card">
          <h3>Filters</h3>
          <div class="group">
            <div class="row">
              <select id="filterType">
                <option value="All">All types</option>
                <option value="Alongsider">Alongsider</option>
                <option value="Church">Church</option>
                <option value="Partner Org">Partner Org</option>
                <option value="Supporter">Supporter</option>
              </select>
              <select id="filterDegree" title="Degree">
                <option value="All">All degrees</option>
                <option value="1">1st degree</option>
                <option value="2">2nd degree</option>
              </select>
            </div>
            <div class="row">
              <input id="filterTag" placeholder="Filter by tag…"/>
              <input id="searchName" placeholder="Search name…"/>
            </div>
          </div>
          <div class="divider"></div>
          <div class="group">
            <div class="row">
              <select id="filterRel">
                <option value="All">All lines</option>
                <option value="leads">Leads</option>
                <option value="supports">Supports</option>
                <option value="partners">Partners</option>
                <option value="linked">Linked</option>
              </select>
              <label class="row" style="align-items:center;gap:6px">
                <input type="checkbox" id="toggleLines" checked/> Show lines
              </label>
            </div>
          </div>
          <div class="divider"></div>
          <h3>Legend</h3>
          <div class="legend">
            <span class="pill"><span class="dot c-alongsider"></span> Alongsider</span>
            <span class="pill"><span class="rect c-church"></span> Church</span>
            <span class="pill"><span class="diamond c-partner"></span> Partner Org</span>
            <span class="pill"><span class="dot c-supporter"></span> Supporter</span>
          </div>
          <div class="legend" style="margin-top:8px">
            <span class="pill"><span class="dot r-leads"></span> leads</span>
            <span class="pill"><span class="dot r-supports"></span> supports</span>
            <span class="pill"><span class="dot r-partners"></span> partners</span>
            <span class="pill"><span class="dot r-linked"></span> linked</span>
          </div>
        </div>

        <div class="card">
          <h3>Cluster items</h3>
          <div id="clusterList" class="cluster">
            <div class="muted">Click a cluster on the map to list its items here.</div>
          </div>
        </div>

        <div class="card">
          <h3>Quick actions</h3>
          <div class="row">
            <button class="btn" id="copyLink">Copy view link</button>
            <span class="muted" id="dataStamp">Data: …</span>
          </div>
        </div>
      </aside>
    </main>

    <footer>
      © Alongside Ministries — Map by Aqua • <a style="color:var(--accent2);text-decoration:none" href="register.html">Submit a change</a>
    </footer>
  </div>

  <script>
    // ======= CONFIG =======
    const MAPBOX_TOKEN = "pk.eyJ1IjoiYXF1YWIxcmQiLCJhIjoiY21ndjl5Y2RzMGN2azJsc2J4d3d2N2tyeSJ9.JApvZZEs_kiwNl4Y9-aRaQ";
    const NODES_CSV_URL = "https://docs.google.com/spreadsheets/d/1MSwF46BkDjRhOdHd4Pw0ArCVgvdcgDACWvyswFq8XI4/gviz/tq?tqx=out:csv&sheet=Nodes";
    const EDGES_CSV_URL = "https://docs.google.com/spreadsheets/d/1eQrmiVA4wxf6J79SZkyhZb-vEAyX3yxfapen113MSrA/gviz/tq?tqx=out:csv&sheet=Edges";

    // ======= STATE =======
    let allNodes = [];        // raw array
    let allEdges = [];        // raw array
    let filteredNodes = [];   // after filters
    let filteredEdges = [];   // after filters
    let nodeIndex = new Map();// id -> node

    // ======= MAP SETUP =======
    mapboxgl.accessToken = MAPBOX_TOKEN;
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/dark-v11',
      center: [10, 38],
      zoom: 2.1,
      pitch: 0,
      attributionControl: true
    });
    map.addControl(new mapboxgl.NavigationControl({visualizePitch:false}));
    map.addControl(new mapboxgl.ScaleControl({unit:'metric'}));

    function toast(msg, ms=2200){
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=> t.style.display='none', ms);
    }

    // Draw simple SVG icons into canvas -> addImage
    function makeIcon(shape='circle', color='#fff', size=24){
      const c = document.createElement('canvas');
      c.width = c.height = size;
      const ctx = c.getContext('2d');
      ctx.clearRect(0,0,size,size);
      ctx.fillStyle = color;
      // glow
      ctx.shadowColor = color;
      ctx.shadowBlur = 8;
      const pad = 5;
      if (shape === 'circle'){
        ctx.beginPath();
        ctx.arc(size/2, size/2, (size/2)-pad, 0, Math.PI*2);
        ctx.fill();
      } else if (shape === 'rect'){
        const r = 4;
        const w = size - pad*2, h = size - pad*2;
        const x = pad, y = pad;
        ctx.beginPath();
        ctx.moveTo(x+r, y);
        ctx.arcTo(x+w, y, x+w, y+h, r);
        ctx.arcTo(x+w, y+h, x, y+h, r);
        ctx.arcTo(x, y+h, x, y, r);
        ctx.arcTo(x, y, x+w, y, r);
        ctx.closePath();
        ctx.fill();
      } else if (shape === 'diamond'){
        ctx.beginPath();
        ctx.moveTo(size/2, pad);
        ctx.lineTo(size-pad, size/2);
        ctx.lineTo(size/2, size-pad);
        ctx.lineTo(pad, size/2);
        ctx.closePath();
        ctx.fill();
      }
      const img = new Image();
      img.src = c.toDataURL('image/png');
      return img;
    }

    async function addTypeIcons(){
      // Ensure style is fully ready before addImage
      if (!map.isStyleLoaded()) {
        await new Promise(r => map.once('load', r));
      }
      const add = (name, shape, color) => new Promise(res=>{
        const img = makeIcon(shape, color, 32);
        img.onload = ()=> {
          if(!map.hasImage(name)) map.addImage(name, img, {pixelRatio:2});
          res();
        };
      });
      const css = getComputedStyle(document.documentElement);
      const c = v => css.getPropertyValue(v).trim();
      await Promise.all([
        add('icon-alongsider','circle', c('--t-alongsider')),
        add('icon-church','rect', c('--t-church')),
        add('icon-partner','diamond', c('--t-partner')),
        add('icon-supporter','circle', c('--t-supporter'))
      ]);
    }

    // ======= DATA LOADING =======
    function parseBool(v){ return String(v).toLowerCase().trim() === 'true'; }

    function loadCSV(url){
      return new Promise((resolve, reject)=>{
        Papa.parse(url, {
          download: true, header: true, dynamicTyping: false, skipEmptyLines: true,
          complete: results => resolve(results.data),
          error: err => reject(err)
        });
      });
    }

    async function loadData(){
      const [nodes, edges] = await Promise.all([loadCSV(NODES_CSV_URL), loadCSV(EDGES_CSV_URL)]);

      // Normalize nodes
      allNodes = nodes
        .filter(d => !('public' in d) || parseBool(d.public))
        .map(d => {
          const lat = parseFloat(String(d.lat||'').replace(',', '.'));
          const lon = parseFloat(String(d.lon||'').replace(',', '.'));
          return {
            id: String(d.id||'').trim(),
            name: d.name || '',
            type: d.type || '',
            city: d.city || '',
            country: d.country || '',
            lat, lon,
            tags: d.tags || '',
            url: d.url || '',
            gmaps: d.gmaps || '',
            degree: (d.degree ? String(d.degree).trim() : ''),
            raw: d
          };
        }).filter(d => isFinite(d.lat) && isFinite(d.lon) && d.id);

      nodeIndex = new Map(allNodes.map(n => [n.id, n]));

      // Normalize edges
      allEdges = edges
        .filter(d => !('public' in d) || parseBool(d.public))
        .map(d => ({
          source_id: String(d.source_id||'').trim(),
          target_id: String(d.target_id||'').trim(),
          relationship: String(d.relationship||'').trim().toLowerCase(),
          since: d.since || ''
        }))
        .filter(e => nodeIndex.has(e.source_id) && nodeIndex.has(e.target_id));

      applyFilters();
      document.getElementById('dataStamp').textContent = 'Data last updated: ' + (new Date()).toLocaleString();
    }

    // ======= FILTERING =======
    const ui = {
      filterType: document.getElementById('filterType'),
      filterDegree: document.getElementById('filterDegree'),
      filterTag: document.getElementById('filterTag'),
      searchName: document.getElementById('searchName'),
      filterRel: document.getElementById('filterRel'),
      toggleLines: document.getElementById('toggleLines'),
      quickType: document.getElementById('quickType'),
      quickSearch: document.getElementById('quickSearch'),
      clusterList: document.getElementById('clusterList')
    };

    function applyFilters(){
      const type = (ui.filterType.value || 'All').trim();
      const degree = (ui.filterDegree.value || 'All').trim();
      const tag = (ui.filterTag.value || '').toLowerCase().trim();
      const q = (ui.searchName.value || '').toLowerCase().trim();
      const rel = (ui.filterRel.value || 'All').trim().toLowerCase();
      const showLines = ui.toggleLines.checked;

      filteredNodes = allNodes.filter(n=>{
        if (type !== 'All' && n.type !== type) return false;
        if (degree !== 'All' && String(n.degree||'') !== degree) return false;
        if (tag && !String(n.tags||'').toLowerCase().includes(tag)) return false;
        if (q && !String(n.name||'').toLowerCase().includes(q)) return false;
        return true;
      });

      const allowedIds = new Set(filteredNodes.map(n=>n.id));
      filteredEdges = showLines
        ? allEdges.filter(e=>{
            if (rel !== 'All' && e.relationship !== rel) return false;
            return allowedIds.has(e.source_id) && allowedIds.has(e.target_id);
          })
        : [];

      updateSources();
    }

    // ======= SOURCES & LAYERS =======
    function nodesToGeoJSON(nodes){
      return {
        type:'FeatureCollection',
        features: nodes.map(n=>({
          type:'Feature',
          geometry:{ type:'Point', coordinates:[n.lon, n.lat] },
          properties: {
            id:n.id, name:n.name, type:n.type, city:n.city, country:n.country,
            tags:n.tags, url:n.url, gmaps:n.gmaps, degree:String(n.degree||'')
          }
        }))
      };
    }

    function edgesToGeoJSON(edges){
      return {
        type:'FeatureCollection',
        features: edges.map(e=>{
          const s = nodeIndex.get(e.source_id);
          const t = nodeIndex.get(e.target_id);
          return {
            type:'Feature',
            geometry:{ type:'LineString', coordinates:[[s.lon, s.lat],[t.lon, t.lat]] },
            properties:{ relationship:e.relationship, source_id:e.source_id, target_id:e.target_id, since:e.since }
          }
        })
      };
    }

    function addSourcesAndLayers(){
      // Nodes source (clustered)
      if (!map.getSource('nodes')){
        map.addSource('nodes', {
          type:'geojson',
          data: nodesToGeoJSON(filteredNodes),
          cluster: true,
          clusterRadius: 60,
          clusterMaxZoom: 12
        });
      }

      // Cluster layers (guard re-add)
      if (!map.getLayer('clusters')){
        map.addLayer({
          id:'clusters',
          type:'circle',
          source:'nodes',
          filter:['has','point_count'],
          paint:{
            'circle-color': [
              'step', ['get','point_count'],
              'rgba(79,179,255,0.35)', 5,
              'rgba(53,179,168,0.40)', 15,
              'rgba(53,179,168,0.55)'
            ],
            'circle-radius': [
              'step',['get','point_count'],
              14, 5, 18, 15, 24, 50, 30
            ],
            'circle-stroke-color':'#152330',
            'circle-stroke-width':1.5
          }
        });
      }

      if (!map.getLayer('cluster-count')){
        map.addLayer({
          id:'cluster-count',
          type:'symbol',
          source:'nodes',
          filter:['has', 'point_count'],
          layout:{
            'text-field':['get','point_count_abbreviated'],
            'text-size':12
          },
          paint:{ 'text-color':'#dff2ff' }
        });
      }

      // Unclustered points (symbol icons by type)
      if (!map.getLayer('unclustered-points')){
        map.addLayer({
          id:'unclustered-points',
          type:'symbol',
          source:'nodes',
          filter:['!', ['has','point_count']],
          layout:{
            'icon-image': [
              'match', ['get','type'],
                'Alongsider','icon-alongsider',
                'Church','icon-church',
                'Partner Org','icon-partner',
                'Supporter','icon-supporter',
                'icon-alongsider'
            ],
            'icon-size': 0.75,
            'icon-allow-overlap': true
          }
        });
      }

      // Edges source + layer
      if (!map.getSource('edges')){
        map.addSource('edges', { type:'geojson', data: edgesToGeoJSON(filteredEdges) });
      }
      if (!map.getLayer('edges-line')){
        map.addLayer({
          id:'edges-line',
          type:'line',
          source:'edges',
          paint:{
            'line-width': [
              'match', ['get','relationship'],
                'leads', 2.4,
                'supports', 2.4,
                'partners', 2.4,
                1.8
// get CSS variable values as real colors
const css = getComputedStyle(document.documentElement);
const colorLeads     = css.getPropertyValue('--r-leads').trim();
const colorSupports  = css.getPropertyValue('--r-supports').trim();
const colorPartners  = css.getPropertyValue('--r-partners').trim();
const colorLinked    = css.getPropertyValue('--r-linked').trim();

map.addLayer({
  id:'edges-line',
  type:'line',
  source:'edges',
  paint:{
    'line-width': [
      'match', ['get','relationship'],
        'leads', 2.4,
        'supports', 2.4,
        'partners', 2.4,
        1.8
    ],
    'line-color': [
      'match', ['get','relationship'],
        'leads',    colorLeads,
        'supports', colorSupports,
        'partners', colorPartners,
        colorLinked
    ],
    'line-opacity': 0.85
  }
}, 'unclustered-points');

            'line-opacity': 0.85
          }
        }, 'unclustered-points'); // draw lines beneath symbols
      }
    }

    function updateSources(){
      if (map.getSource('nodes')){
        map.getSource('nodes').setData(nodesToGeoJSON(filteredNodes));
      }
      if (map.getSource('edges')){
        map.getSource('edges').setData(edgesToGeoJSON(filteredEdges));
      }
    }

    // ======= INTERACTION =======
    function nodeHTML(p){
      const lines = [];
      lines.push(`<div style="font-weight:600;margin-bottom:4px">${p.name} <span class="tag">(${p.type})</span></div>`);
      const loc = [p.city,p.country].filter(Boolean).join(', ');
      if (loc) lines.push(`<div class="tag" style="margin-bottom:6px">${loc}</div>`);
      if (p.tags) lines.push(`<div class="tag">Tags: ${p.tags}</div>`);
      const links = [];
      if (p.url) links.push(`<a href="${p.url}" target="_blank" rel="noopener">Website</a>`);
      if (p.gmaps) links.push(`<a href="${p.gmaps}" target="_blank" rel="noopener">Google Maps</a>`);
      if (links.length) lines.push(`<div style="margin-top:8px;display:flex;gap:10px">${links.join(' • ')}</div>`);
      return lines.join('');
    }

    function onMapClick(){
      // Cluster click -> zoom in and list leaves
      map.on('click','clusters', (e)=>{
        const features = map.queryRenderedFeatures(e.point, { layers:['clusters'] });
        if (!features.length) return;
        const clusterId = features[0].properties.cluster_id;
        map.getSource('nodes').getClusterExpansionZoom(clusterId, (err, zoom)=>{
          if (err) return;
          map.easeTo({ center: features[0].geometry.coordinates, zoom });
          // list items
          map.getSource('nodes').getClusterLeaves(clusterId, 100, 0, (err, leaves)=>{
            if (err) return;
            showClusterList(leaves.map(f=> ({
              id: f.properties.id,
              name: f.properties.name,
              type: f.properties.type,
              city: f.properties.city,
              lat: f.geometry.coordinates[1],
              lon: f.geometry.coordinates[0]
            })));
          });
        });
      });

      // Unclustered point click -> popup + center
      map.on('click','unclustered-points', (e)=>{
        const f = e.features[0];
        const c = f.geometry.coordinates.slice();
        const p = f.properties;
        new mapboxgl.Popup({ offset: 12, maxWidth:'320px' })
          .setLngLat(c).setHTML(nodeHTML(p)).addTo(map);
        map.easeTo({ center: c, zoom: Math.max(map.getZoom(), 5.5) });
      });

      map.on('mouseenter','clusters', ()=> map.getCanvas().style.cursor='pointer');
      map.on('mouseleave','clusters', ()=> map.getCanvas().style.cursor='');
      map.on('mouseenter','unclustered-points', ()=> map.getCanvas().style.cursor='pointer');
      map.on('mouseleave','unclustered-points', ()=> map.getCanvas().style.cursor='');
    }

    function showClusterList(items){
      const box = ui.clusterList;
      if (!items || !items.length){
        box.innerHTML = '<div class="muted">No items.</div>';
        return;
      }
      box.innerHTML = items.map(n => `
        <div class="cluster-item" data-id="${n.id}">
          <div>
            <div>${n.name} <span class="tag">(${n.type})</span></div>
            <div class="tag">${n.city||''}</div>
          </div>
          <div class="chip">${n.id}</div>
        </div>
      `).join('');
      box.querySelectorAll('.cluster-item').forEach(elm=>{
        elm.addEventListener('click', ()=>{
          const id = elm.getAttribute('data-id');
          const n = nodeIndex.get(id);
          if (!n) return;
          map.easeTo({ center:[n.lon, n.lat], zoom: 7.5 });
          new mapboxgl.Popup({ offset: 12 }).setLngLat([n.lon,n.lat]).setHTML(nodeHTML(n)).addTo(map);
        });
      });
    }

    // ======= UI WIRING =======
    function syncType(val){
      ui.filterType.value = val;
      ui.quickType.value = val;
      applyFilters();
    }

    ui.filterType.addEventListener('change', e=> syncType(e.target.value));
    ui.filterDegree.addEventListener('change', ()=> applyFilters());
    ui.filterTag.addEventListener('input', ()=> applyFilters());
    ui.searchName.addEventListener('input', ()=> { ui.quickSearch.value = ui.searchName.value; applyFilters(); });

    ui.filterRel.addEventListener('change', ()=> applyFilters());
    ui.toggleLines.addEventListener('change', ()=> applyFilters());

    ui.quickType.addEventListener('change', e=> syncType(e.target.value));
    ui.quickSearch.addEventListener('input', e=> { ui.searchName.value = e.target.value; applyFilters(); });

    document.getElementById('resetView').addEventListener('click', ()=>{
      map.easeTo({ center:[10,38], zoom:2.1 });
    });

    document.getElementById('copyLink').addEventListener('click', ()=>{
      navigator.clipboard.writeText(location.href).then(()=> toast('View link copied'));
    });

    // ======= INIT (safer) =======
    map.on('load', async () => {
      // ensure style is ready before adding images
      if (!map.isStyleLoaded()) {
        await new Promise(r => map.once('load', r));
      }
      try{
        await addTypeIcons();        // custom icons (circle/rect/diamond)
        await loadData();            // fetch Nodes + Edges CSV
        addSourcesAndLayers();       // add layers
        onMapClick();                // wire interactions
        toast('Map ready');
        map.resize();                // ensure proper render after layout
      }catch(err){
        console.error('Init error:', err);
        toast('Error initializing map. Check console.');
      }
    });

    // Hot reload data helper (optional)
    window.refreshData = async function(){
      await loadData();
      toast('Data refreshed');
    };
  </script>
</body>
</html>
